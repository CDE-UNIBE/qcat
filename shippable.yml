# Shippable CI/CD configuration file.
# http://docs.shippable.com/en/latest/config.html#configuration
language:
  python

python:
  - 3.6

env:
  global:
    - secure: ZlkIu4371ZDbvCZlubzlCaitdjvT+ftrnalej8laXC27UUMf5RKWlGbtuWOIzDBjV4UBIUfXE/ghA4ZxptZbOAWahr9i+nnUoku1VxGN+jWB9T0Gs9ZVuGhIOYDwOCjNQZfp/csHVKeNvHXeFTT1rugQVMrLYwuOwJ3XRV0ULdykUE9bUbLr2FGJuOfo97yABAnvPepTWnQd3GYjFqOZJ0DHi9KJGGX8A3ckZ4VPQ440xoR/WiDnXNvuO2T0pn15MlXDyxYcIHC/Uf9Uw5x5Bqp9N8gUtAFn45SDLQWUzOh1WroNA2XvBoztmJhBPEAkfAu80HEGauI6GDEw/URIhc/XgnShg6V917z33C1MX1drs/QwFo0z8MxVY0POOgC00MlZKR96A79/qF3mus8baAGAx5Ta8ao/Ztd4MZIS4bvNL0m4aX9iFs5zMYScKAXBTsPZK5tYrVBvzvKYLD395UwrhqcMNVfcEwLQ+EDJV+SCpndzrSQvMb3HQ4O3BLphxv+t0Qs11F/TY6rfHajh4gAXD2skWoCVELegattmGxfZ1Kcvub9FrHJaG2Vs1p3uRgQIlaLgGFkaaJtQ1G5ME5yhnX52rs/X6J4Z7kzG+n93EMUJAX9Tw6ltvD81DM8P4wnUZ6RuoL8eLE0KNKBiO7j8pkWSjEq1t0x28XzNFW5cmPHMsL6UodSyHuIs10OSXVB3/bsplG+MDAhFnXinm46G64zh2thXgAM8vO/wkfl+u9/7KwvqP6SVnzCvI9Z5wht7s4IKUw94Q4yH4b4wIMPQ1Jc01b5Ri6SRSAFL7TRwGWWho7fBotw9fodTjR+gePsEuXbYBJ2rVu0kDleT/D/1LUknUdxF7oRpafGGx4GppchIG9+/dxAB+voBblj7yNhH4w+wH0CTpgjPwjwKTqvSzieBsJctaWcuUbBGXuz3xe4pzYUxWWU+tADWMfXqlFO2xEXCcw5MeDN9pWLbJZiF4iOyWFA4mcY3QbPV/nd+Mn+W6cs+ycbighXaMmUA

services:
  - postgres
  - redis
  - selenium

build:
  pre_ci_boot:
    image_name: drydock/u16pytall
    image_tag: v5.10.2

  ci:
    # Install system (os) dependencies
    - export LC_ALL=C
    - sudo apt-get update && sudo apt-get -y install python3-pip libjpeg-dev libjpeg8-dev binutils libproj-dev gdal-bin openssl libssl-dev libxrender-dev libx11-dev libxext-dev libfontconfig1-dev libfreetype6-dev fontconfig
    # Shippable uses elasticsearch 6.x, which is not supported by qcat. Install 2.x manually.
    - wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.4.6/elasticsearch-2.4.6.deb
    - dpkg -i elasticsearch-2.4.6.deb
    - service elasticsearch start
    # Install wkhtmltopdf for pdf generation
    - wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.4/wkhtmltox-0.12.4_linux-generic-amd64.tar.xz
    - tar xvf wkhtmltox-0.12.4_linux-generic-amd64.tar.xz
    - mv wkhtmltox/bin/wkhtmlto* /usr/local/bin
    # Setup database with postgis...
    - psql -c "create role shippable with superuser login password '123456'" -U postgres
    - psql -c 'create database qcat;' -U postgres
    - psql -d "qcat" -U postgres -c "create extension postgis"
    # ...and minimal required env vars
    - echo "`pwd`/apps" > `python3 -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"`/_qcat_path.pth
    - echo "DevDefaultSite" > envs/DJANGO_CONFIGURATION
    - echo "qcat.settings" > envs/DJANGO_SETTINGS_MODULE
    - echo "postgis://shippable:123456@localhost:5432/qcat" > envs/DATABASE_URL
    - echo "123" > envs/DJANGO_SECRET_KEY
    - echo "True" > envs/DJANGO_DEBUG
    - echo "" > envs/NEXT_MAINTENANCE
    # Install python packages.
    - pip install -r requirements/development.txt
    - pip install -r requirements/production.txt
    # Run tests, and put results to folders read by shippable.
    - export DISPLAY=:99.0
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    - mkdir ../upload
    - xvfb-run --server-args="-ac" python manage.py test -a unit --with-xunit --xunit-file=shippable/testresults/nosetests.xml --with-coverage --cover-xml --cover-xml-file=shippable/codecoverage/coverage.xml
    - unset LC_ALL

  on_success:
    - fab deploy:$BRANCH

  cache: true

branches:
  only:
    - develop
    - master
    - feature/1782-new-configuration-poc

integrations:
  notifications:
    - integrationName: slack-integration
      type: slack
      recipients:
        - "#server-info"
      on_success: never
      on_failure: always

    - integrationName: email
      type: email
      on_success: never
      on_failure: never
      on_pull_request: never
