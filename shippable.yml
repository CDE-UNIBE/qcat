# Shippable CI/CD configuration file.
# http://docs.shippable.com/en/latest/config.html#configuration
language: python
python:
   - "3.4"

branches:
  only:
    - develop
    - master

env:
  # secure keys must include:
  # HOST_STRING_DEV
  # HOST_STRING_LIVE
  # OPBEAT_BEARER_DEV
  # OPBEAT_URL_DEV
  # OPBEAT_BEARER_LIVE
  # OPBEAT_URL_LIVE
  # AUTH_API_USER
  # AUTH_API_KEY
  # these values are used for testing / deployment only, so the must not
  # necessarily match the proper values from develop / production.

  global:
    - secure: pD+2LVgQP/4XtkB2HhsYMt7T5Gd2lg0J7ehbBAtfnfju/PtRQ03VMYq21lxGyG0y5yTxm2FVpmQ0bs18tv352TaWhThXODQS48509sssg5Foi6qLUbpkNBg9Hek0XmjdnPFF5+c+vdj/V6aajdbMubrjVcgWWjWBRFYeSxEDA5NW0MajCXNNMtAOp6iPbzH3UR6YRBtvT2tlssVkzY+O1YvbFIoE5WSm3KkHMf9bXYfeh+mD1gOvBn2chDbvzl33pqVbLj0jf0PyQOgIeglLJOWAsa3y+yUpjE67DWVnpx2C1EJ6NHLxEMzMQepVDbKhMLxt3AxemktNuxajRI0CArOqDpVaPFCerKL2qen1/wxGELH7iksc9oOEH1hb3mScSbSNXkp7sqw5dO5Tpr4rv5HgzgsUl7Nbz4mM11IYAhEfUk2Jc/z2s1NQdTacP6uFNo0Ec3UkR/mrCORHrGW/XVuSNMz3GJOwgKuXzyQppqgrUZXOaKFabSH3ywqiAhZ+yZ9IOi0t9EspKWeaMAg6Gc8Rf/pAFrfno6vX/gea+DyddfkUqvHcrahKRh3tT6fg9ZYIl0Q1LS2epbYnqyXSKblFYP/uVLenLza2tTxNmx+qGrqEt9OV8nMS9gfWnXQ9TrG4xeA1Mr/cO9WXICt+J6AG7UCaGUEUBkSCcZp9k85lmxyEuUV99rA6hz89y5hP8eRUc8Q4L2vZU1M3R5DvSFXak1pAg/qZ1YGqL44/fimhm5XecZir076hmIp8kpE3c8gk9e0u9E+Xd5WHJNTX8lqu15qPl4zj0IOotS6iyivbMgNFsXV25+A/1T8B0qDRexW3nq0hMSWjHWOvfVvMTgqPlhM6skJV9OmIV8eDoFECWyePii8C3q3+Ju8ieKn+fDf/1Ntj+puAxSvbzoZ9CS3tYlHaL7GMcYONc+hKPYs+P1g/E5xCmGFI0304SD24sT9Q/5c6INbrVRN4fk5C3wgZyA5RGm3Iw0wdo7lApLccShraM7Wu9GiAbow0Ji9sgSQcLg9S3npFtCGjLpWOfWS28b1rhqfMh9matW+7rKh8HD5PTCd94W17BOwkZ9FvOqAWX+CIqrPDceY8IRlxItwUwVG5OKtbBkO4XUr+ZKy/cqUxpd8WwCV/Z4zLwF6L4TXC44caGOvO5Z94Kfsf42drw9zMuKNtgVRcbnu0OcVb8SgIorLOGn3NBPVTaSOcTxsQs26xhMv4x3D/ZSDNoOqHXzi4DvvM2GNTjN6yfAK9x2jezQ0MkYo9SsarxoPmjkp+2jgm909YsiBMUfGUU7qdjZsi3sTVpenUKTUM7D804Aec9I/mhMZUSZQQhqYVzn11adRLzNy19VGuJICjVQ==

cache: true

#addons:
#  - firefox: "48.0"

#services:
#  - selenium

install:
#  - sudo npm install --global npm@1.4.21
#  - sudo npm install -g grunt-cli
#  - npm install
#  - bower install --allow-root
#  - grunt build
  - pip3 install -r requirements/development.txt
  - pip3 install -r requirements/production.txt

before_script:
#  - "/etc/init.d/xvfb start"
#  - "export DISPLAY=:99.0"
#  # postgres for tests
#  - psql -c 'CREATE ROLE qcat_test LOGIN SUPERUSER INHERIT CREATEDB CREATEROLE REPLICATION;' -U postgres
#  - psql -c 'CREATE DATABASE "qcat_test";' -U postgres
#  - psql -c 'CREATE EXTENSION postgis;' -U postgres -d qcat_test
#  - psql -c "ALTER USER qcat_test WITH PASSWORD '123456';" -U postgres
#  # postgres for the application
#  - psql -c 'CREATE ROLE qcat LOGIN SUPERUSER INHERIT CREATEDB CREATEROLE REPLICATION;' -U postgres
#  - psql -c 'CREATE DATABASE "qcat";' -U postgres
#  - psql -c 'CREATE EXTENSION postgis;' -U postgres -d qcat
#  - psql -c "ALTER USER qcat WITH PASSWORD '123456';" -U postgres
#  # Put our 'apps' directory to the sys.path so our apps can be loaded..
  - echo "`pwd`/apps" > /home/shippable/build_ve/python/3.4/lib/python3.4/site-packages/_qcat_path.pth
  - echo "ProdDefaultSite" > envs/DJANGO_CONFIGURATION
  - echo "qcat.settings" > envs/DJANGO_SETTINGS_MODULE
  - echo "postgis://qcat:123456@localhost:5432/qcat" > envs/DATABASE_URL
  - echo "123" > envs/DJANGO_SECRET_KEY
#  # Prepare application: load initial data and create static assets.
#  - python manage.py migrate --noinput
#  - python load_qcat_data
#  - python create_es_indexes
#  - python manage.py collectstatic --noinput
#  # For selenium
#  - "export DISPLAY=:99.0"

#script:
#  - flake8
#  - coverage run --source='.' manage.py test

#after_script:
#  - "/etc/init.d/xvfb stop"

after_success:
#  - mv coverage.xml shippable/codecoverage/
#  - mv unittests.xml shippable/testresults/
#  - mv reports/*.xml shippable/testresults/ && rmdir reports
  - fab deploy:$BRANCH
  - fab register_deployment:$BRANCH

notifications:
  email:
    on_success: change
    on_failure: always
