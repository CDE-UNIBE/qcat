# Shippable CI/CD configuration file.
# http://docs.shippable.com/en/latest/config.html#configuration
language: python
python: 3.4

branches:
  only:
    - develop
    # - master

env:
  secure: <host_string>  # http://shippable-docs-20.readthedocs.org/en/latest/config.html#configuration

addons:
  - postgresql: 9.4
  - firefox: 48.0
services:
  - selenium
  - elasticsearch

before_install:
  - source ~/.rvm/scripts/rvm && rvm use 2.0.0
install:
  - bundler install
  - npm install
  - bower install
  - pip install -r requirements/development.txt

before_script:
  - "export DISPLAY=:99.0"
  - fab $BRANCH <set_envs>
  - fab $BRANCH <load_fixtures>
  - fab $BRANCH <create_elasticsearch_index>
  - /etc/init.d/xvfb start
script:
  - flake8
  - coverage run --source='src/' src/manage.py test
after_script:
  - /etc/init.d/xvfb stop

after_success:
  - mv coverage.xml shippable/codecoverage/
  - mv unittests.xml shippable/testresults/
  - mv reports/*.xml shippable/testresults/ && rmdir reports
  - fab $BRANCH deploy

notifications:
  email:
    on_success: always
    on_failure: always
