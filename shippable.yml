# Shippable CI/CD configuration file.
# http://docs.shippable.com/en/latest/config.html#configuration
language: python
python: 3.4

branches:
  only:
    # - develop
    # - master
    feature/shippable-ci

env:
  - secure: k412pgPHDWVvi2I0y6ZufivZ5h7TDxDNyaDwAUsUYQ1iBtDDI92cZdiqdo+OHAtR4JfAtfrj7xG37QdLvnES7ZuswTs9urXrW1lTLfSYzCW52o+SwO4ZIZlqVdW+5OS8U4T8+afamlOmnCYlM+pH2dbIXLM32lrPJkc03rA89dW0p5RbU607Sj2hSfB4/k9lj4nBORCamU2SLR/3DVFheN3owFW5jf2F9Xm/UTHuurAWQHLpsYHGGrVxX/7c9IR32wnLPyXFyizQ6nFbRHN0vcWGfMAV/AhvLseayg9p1NTvAfdIc6ngtsEDfiuIqgKk7MQwS6hjRIYaquiUr4w2vw==

addons:
  - postgresql: 9.4
  - firefox: 48.0
services:
  - selenium
  - elasticsearch

before_install:
  - source ~/.rvm/scripts/rvm && rvm use 2.0.0
install:
  - bundler install
  - npm install
  - bower install
  - pip install -r requirements/development.txt

before_script:
  - "export DISPLAY=:99.0"
  - fab $BRANCH <set_envs>
  - fab $BRANCH load_qcat_data
  - fab $BRANCH <create_elasticsearch_index>
  - /etc/init.d/xvfb start
script:
  - flake8
  - coverage run --source='src/' src/manage.py test
after_script:
  - /etc/init.d/xvfb stop

after_success:
  - mv coverage.xml shippable/codecoverage/
  - mv unittests.xml shippable/testresults/
  - mv reports/*.xml shippable/testresults/ && rmdir reports
  - fab $BRANCH deploy

notifications:
  email:
    on_success: always
    on_failure: always
