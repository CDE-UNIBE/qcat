{% load i18n %}
{% load compress %}

<section class="row is-rhythmed{% if review_css_class %} {{ review_css_class }}{% endif %}">
  <div class="small-12 columns">
    <h2 class="is-unvisible">{% trans "Status of review process" %}</h2>
    <ol class="process">
      <li class="{% if review_config.review_status == 1 %}is-current{% else %}is-done{% endif %}">{% trans "Edit" %}</li>
      <li class="{% if review_config.review_status == 2 %}is-current{% else %}is-done{% endif %}">{% trans "Review" %}</li>
      <li class="{% if review_config.review_status == 3 %}is-current{% else %}is-done{% endif %}">{% trans "Publish" %}</li>
    </ol>
    <div class="process-status">
      <div class="row collapse">
        <form action="" method="POST">
          <div style='display:none'><input type='hidden' name='csrfmiddlewaretoken' value='{{ review_config.csrf_token_value }}'/></div>
          {% if review_config.review_status == 1 %}
            <div class="{% if 'submit_questionnaire' in review_config.permissions %}medium-8{% else %}medium-12{% endif %} columns">
              <h3>{% trans "Edit" %}</h3>
              <p>{% trans "The version is saved as a draft. Editors can work on the draft. The compiler can submit it for review." %}</p>
              {% if review_config.blocked_by %}
                <p id="is-blocked" data-confirm="{% trans "Someone is still editing this questionnaire. If you submit it, these changes will be lost. Are you sure you want to proceed?" %}">{{ review_config.blocked_by }}</p>
              {% endif %}
            </div>
            <div class="medium-4 columns text-right">
              {% if 'submit_questionnaire' in review_config.permissions %}
                <input id="button-submit" name="submit" class="button small is-ok" type="submit" value="{% trans "Submit" %}" data-tooltip aria-haspopup="true" title="{% trans 'The questionnaire will be submitted for review. Next status will be 'pending' and reviewers will be notified.' %}">
              {% endif %}
            </div>
          {% elif review_config.review_status == 2 %}
            <div class="{% if 'review_questionnaire' in review_config.permissions %}medium-8{% else %}medium-12{% endif %} columns">
              <h3>{% trans "Pending for review" %}</h3>
              <p>{% trans "This questionnaire is currently waiting to be reviewed before it can be published." %}</p>
            </div>
            {% if 'review_questionnaire' in review_config.permissions %}
              <div class="medium-4 columns text-right">
                <input id="button-review" name="review" class="button small is-ok" type="submit" value="{% trans "Approve" %}" data-tooltip aria-haspopup="true" title="{% trans 'The questionnaire is ready to be checked for publishing. Next status will be 'reviewed' and publishers will be notified.' %}">
                <input id="button-reject" name="reject" class="button small is-dangerous" type="submit" value="{% trans "Reject" %}" data-tooltip aria-haspopup="true" title="{% trans 'The questionnaire is not acceptable and it needs to be edited again. Next status will be 'draft' and editors will be notified.' %}">
              </div>
            {% endif %}
          {% elif review_config.review_status == 3 %}
            <div class="{% if 'publish_questionnaire' in review_config.permissions %}medium-8{% else %}medium-12{% endif %} columns">
              <h3>{% trans "Pending for publishing" %}</h3>
              <p>{% trans "This questionnaire is currently waiting to be published. Once it is published, it will be publicly visible." %}</p>
            </div>
            {% if 'publish_questionnaire' in review_config.permissions %}
              <div class="medium-4 columns text-right">
                <input id="button-publish" name="publish" class="button small is-ok" type="submit" value="{% trans "Publish" %}" data-tooltip aria-haspopup="true" title="{% trans 'The questionnaire will be published. Next status will be 'public' and it will be publicly visible.' %}">
                <input id="button-reject" name="reject" class="button small is-dangerous" type="submit" value="{% trans "Reject" %}" data-tooltip aria-haspopup="true" title="{% trans 'The questionnaire is not acceptable and it needs to be edited again. Next status will be 'draft' and editors will be notified.' %}">
              </div>
            {% endif %}
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</section>

{# This should be added to 'js' with sekizai. However, this needs refactoring of the config, and the template structure as a context_instance and template blocks would be required #}
{% compress js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var isBlocked = document.getElementById('is-blocked');
            if (isBlocked !== null) {
                btnSubmit = document.getElementById('button-submit');
                btnSubmit.addEventListener('click', function() {
                    event.preventDefault();
                    var choice = confirm(isBlocked.getAttribute('data-confirm'));
                    if (choice) {
                        window.location.href = this.getAttribute('href');
                    }
                })
            }
        });
    </script>
{% endcompress %}
